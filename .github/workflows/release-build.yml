---
name: Release Build

on:
  release:
    types: [published]

concurrency:
  group: ${{ github.ref }}-${{ github.workflow }}
  cancel-in-progress: true

permissions: {}

jobs:
  build:
    name: Build
    strategy:
      matrix:
        target: ["host", "stm32f407", "windows"]
        configuration: ["RelWithDebInfo"]
    uses: ./.github/workflows/wc-continuous-integration.yml
    with:
      target: ${{ matrix.target }}
      configuration: ${{ matrix.configuration }}

  apply-release-notes-template:
    name: ðŸ“ Apply Release Template
    runs-on: ubuntu-latest
    permissions:
      # Please note that this is an overly broad scope, but GitHub does not
      # currently provide a more fine-grained permission for release modification.
      contents: write # is needed to modify a release
    steps:
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo-and-containers: true
          egress-policy: audit
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Amend release description
        run: |
          set -Eeuo pipefail
          CURRENT_NOTES=$(gh release view "${REF_NAME}" --json body -q '.body')
          HEADER=$(echo "$CURRENT_NOTES" | awk '/^## / {print; exit}')
          TEMPLATE=$(cat "$GITHUB_WORKSPACE/.github/RELEASE_TEMPLATE.md")
          BODY=$(echo "$CURRENT_NOTES" | sed "0,/^## /d")
          gh release edit "${REF_NAME}" --notes "${HEADER}${TEMPLATE}${BODY}"
        env:
          GH_TOKEN: ${{ github.token }}
          REF_NAME: ${{ github.ref_name }}

  update-release-notes:
    name: Update Release Notes (ðŸ¨ ${{ matrix.flavor }})
    strategy:
      matrix:
        flavor: [flex]
    runs-on: ubuntu-latest
    permissions:
      # Please note that this is an overly broad scope, but GitHub does not
      # currently provide a more fine-grained permission for release modification.
      contents: write # is needed to modify a release
    needs: [build, apply-release-notes-template]
    env:
      CONTAINER_FLAVOR: ${{ matrix.flavor }}
      REF_NAME: ${{ github.ref_name }}
      REGISTRY: ghcr.io
    steps:
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo-and-containers: true
          egress-policy: audit
      - name: Inspect manifest and extract digest
        id: inspect-manifest
        run: |
          set -Eeuo pipefail
          output=$(docker buildx imagetools inspect "${REGISTRY}/${GH_REPO}-${CONTAINER_FLAVOR}:${REF_NAME}" --format '{{json .}}')
          echo "digest=$(echo "$output" | jq -r '.manifest.digest // .manifests[0].digest')" >> "$GITHUB_OUTPUT"
        env:
          GH_REPO: ${{ github.repository }}
      - name: Update package details in release
        run: |
          set -Eeuo pipefail
          UPDATED_NOTES=$(gh release view "${REF_NAME}" --json body -q '.body')
          UPDATED_NOTES=${UPDATED_NOTES//"{{ amp-postmaster-${CONTAINER_FLAVOR}-version }}"/"${REF_NAME}"}
          UPDATED_NOTES=${UPDATED_NOTES//"{{ amp-postmaster-${CONTAINER_FLAVOR}-sha }}"/"${DIGEST}"}
          gh release edit "${REF_NAME}" --notes "${UPDATED_NOTES}"
        env:
          DIGEST: ${{ steps.inspect-manifest.outputs.digest }}
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}

  upload-binaries:
    name: ðŸ“„ Upload Binaries
    runs-on: ubuntu-latest
    permissions:
      # Please note that this is an overly broad scope, but GitHub does not
      # currently provide a more fine-grained permission for release modification.
      contents: write # is needed to modify a release
    needs: [build]
    steps:
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo: true
          egress-policy: audit
      - uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: postmaster
      - name: Upload binaries to release
        run: |
          set -Eeuo pipefail
          gh release upload "${REF_NAME}" ./Postmaster-*-Generic-ELF.tar.gz
        env:
          GH_REPO: ${{ github.repository }}
          GH_TOKEN: ${{ github.token }}
          REF_NAME: ${{ github.ref_name }}

  comment-released-prs:
    name: Comment on released PRs
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write # is needed by rdlf0/comment-released-prs-action to post comments on PRs
    steps:
      - uses: step-security/harden-runner@20cf305ff2072d973412fa9b1e3a4f227bda3c76 # v2.14.0
        with:
          disable-sudo-and-containers: true
          egress-policy: audit
      - uses: rdlf0/comment-released-prs-action@a81897eaea04a5faa8779d28607826ddb033321a # v3.1.0
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
